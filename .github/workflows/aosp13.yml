name: Build AOSP 13

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 720

    steps:
      ############################################################
      # 1. 安装依赖
      ############################################################
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git-core gnupg flex bison build-essential zip curl zlib1g-dev \
            gcc-multilib g++-multilib libc6-dev-i386 libncurses5-dev \
            x11proto-core-dev libx11-dev libgl1-mesa-dev libxml2-utils \
            xsltproc unzip fontconfig python3 python-is-python3 \
            bc rsync

      ############################################################
      # 2. 安装 repo 工具
      ############################################################
      - name: Install repo
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      ############################################################
      # 3. 初始化 AOSP 13
      ############################################################
      - name: Repo init
        run: |
          mkdir aosp
          cd aosp
          repo init -u https://android.googlesource.com/platform/manifest \
            -b android-13.0.0_r41

      ############################################################
      # 4. 同步源码
      ############################################################
      - name: Repo sync
        run: |
          cd aosp
          repo sync -c -j$(nproc) --force-sync --no-clone-bundle --no-tags

      ############################################################
      # 5. 设置构建环境
      ############################################################
      - name: Setup build environment
        run: |
          cd aosp
          source build/envsetup.sh
          lunch aosp_arm64-eng

      ############################################################
      # 6. 编译
      ############################################################
      - name: Build
        run: |
          cd aosp
          source build/envsetup.sh
          lunch aosp_arm64-eng
          make -j$(nproc)

      ############################################################
      # 7. 上传产物
      ############################################################
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aosp13-output
          path: |
            aosp/out/target/product/arm64/
