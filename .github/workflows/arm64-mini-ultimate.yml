name: ARM64 Mini Linux ULTIMATE

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            gcc-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu \
            bc bison flex \
            wget xz-utils \
            libssl-dev \
            e2fsprogs

      ############################################################
      # BusyBox (STATIC - CI SAFE)
      ############################################################

      - name: Download BusyBox
        run: |
          wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2
          tar -xjf busybox-1.36.1.tar.bz2

      - name: Build BusyBox Static
        run: |
          cd busybox-1.36.1
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig

          sed -i 's/.*CONFIG_STATIC.*/CONFIG_STATIC=y/' .config
          sed -i 's/CONFIG_TC=y/CONFIG_TC=n/' .config || true
          sed -i 's/CONFIG_WERROR=y/CONFIG_WERROR=n/' .config || true

          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig

          sed -i 's/-Werror//g' Makefile

          make -j$(nproc) ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu-

          mkdir -p ../rootfs
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- \
            CONFIG_PREFIX=../rootfs install

      ############################################################
      # Dropbear (STATIC)
      ############################################################

      - name: Download Dropbear
        run: |
          wget https://matt.ucc.asn.au/dropbear/releases/dropbear-2022.83.tar.bz2
          tar -xjf dropbear-2022.83.tar.bz2

      - name: Build Dropbear Static
        run: |
          cd dropbear-2022.83
          ./configure \
            --host=aarch64-linux-gnu \
            --disable-zlib \
            --enable-static \
            LDFLAGS="-static"

          make PROGRAMS="dropbear dbclient dropbearkey scp" \
            CC=aarch64-linux-gnu-gcc

          mkdir -p ../rootfs/usr/sbin
          cp dropbearmulti ../rootfs/usr/sbin/dropbear

      ############################################################
      # Setup RootFS (NO HEREDOC)
      ############################################################

      - name: Setup RootFS
        run: |
          cd rootfs
          mkdir -p proc sys dev etc tmp var mnt root run
          chmod 1777 tmp

          echo "root:x:0:0:root:/root:/bin/sh" > etc/passwd
          echo "root:x:0:" > etc/group

          printf "::sysinit:/etc/init.d/rcS\n::respawn:-/bin/sh\n" > etc/inittab

          mkdir -p etc/init.d

          printf "#!/bin/sh\nmount -t proc none /proc\nmount -t sysfs none /sys\nmount -t devtmpfs none /dev\necho ARM64 Mini Linux ULTIMATE Ready\n" > etc/init.d/rcS

          chmod +x etc/init.d/rcS

      ############################################################
      # Create EXT4 Image (NO LOOP MOUNT)
      ############################################################

      - name: Create ext4 Image
        run: |
          mkdir image
          mv rootfs image/

          mke2fs -t ext4 \
            -d image/rootfs \
            -L ARM64ROOT \
            -m 0 \
            -O ^64bit \
            arm64-rootfs.img 128M

      ############################################################
      # Package
      ############################################################

      - name: Package
        run: |
          tar -czf arm64-mini-ultimate.tar.gz arm64-rootfs.img

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: arm64-mini-ultimate
          path: arm64-mini-ultimate.tar.gz
