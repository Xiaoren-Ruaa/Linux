name: ARM64 Mini Linux ULTIMATE

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            gcc-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu \
            bc bison flex \
            wget xz-utils \
            libssl-dev \
            e2fsprogs

      ###################################
      # BusyBox
      ###################################

      - name: Download BusyBox
        run: |
          wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2
          tar -xjf busybox-1.36.1.tar.bz2

      - name: Configure BusyBox
        run: |
          cd busybox-1.36.1
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig

          sed -i 's/.*CONFIG_STATIC.*/CONFIG_STATIC=y/' .config
          sed -i 's/CONFIG_TC=y/CONFIG_TC=n/' .config || true
          sed -i 's/CONFIG_WERROR=y/CONFIG_WERROR=n/' .config || true

          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- oldconfig

      - name: Build BusyBox
        run: |
          cd busybox-1.36.1
          sed -i 's/-Werror//g' Makefile

          make -j$(nproc) \
            ARCH=arm64 \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CFLAGS="-O2 -fcommon -Wno-error"

      - name: Install BusyBox to rootfs
        run: |
          cd busybox-1.36.1
          mkdir -p rootfs
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CONFIG_PREFIX=../rootfs install

      ###################################
      # Dropbear SSH
      ###################################

      - name: Download Dropbear
        run: |
          wget https://matt.ucc.asn.au/dropbear/releases/dropbear-2022.83.tar.bz2
          tar -xjf dropbear-2022.83.tar.bz2

      - name: Build Dropbear (static)
        run: |
          cd dropbear-2022.83
          ./configure \
            --host=aarch64-linux-gnu \
            --disable-zlib \
            --enable-static

          make PROGRAMS="dropbear dbclient dropbearkey scp" \
            CC=aarch64-linux-gnu-gcc \
            MULTI=1 \
            STATIC=1

      - name: Install Dropbear
        run: |
          mkdir -p busybox-1.36.1/rootfs/usr/sbin
          cp dropbear-2022.83/dropbearmulti busybox-1.36.1/rootfs/usr/sbin/dropbear

      ###################################
      # 构建完整 RootFS
      ###################################

      - name: Create RootFS Structure
        run: |
          cd busybox-1.36.1/rootfs

          mkdir -p proc sys dev etc tmp var mnt root run
          chmod 1777 tmp

          echo "root:x:0:0:root:/root:/bin/sh" > etc/passwd
          echo "root:x:0:" > etc/group

          cat > etc/inittab <<EOF
::sysinit:/etc/init.d/rcS
::respawn:-/bin/sh
EOF

          mkdir -p etc/init.d

          cat > etc/init.d/rcS <<EOF
#!/bin/sh
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev
echo "ARM64 Mini Linux ULTIMATE Ready"
EOF

          chmod +x etc/init.d/rcS

      ###################################
      # 生成 ext4 镜像
      ###################################

      - name: Create ext4 Image
        run: |
          dd if=/dev/zero of=arm64-rootfs.img bs=1M count=128
          mkfs.ext4 arm64-rootfs.img

          mkdir mnt
          sudo mount -o loop arm64-rootfs.img mnt
          sudo cp -a busybox-1.36.1/rootfs/* mnt/
          sudo umount mnt

      ###################################
      # 打包
      ###################################

      - name: Package
        run: |
          tar -czf arm64-mini-ultimate.tar.gz arm64-rootfs.img

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: arm64-mini-ultimate
          path: arm64-mini-ultimate.tar.gz
