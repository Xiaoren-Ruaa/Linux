name: Build QEMU ARM64 (for Android Magisk)

on:
  push:
  workflow_dispatch:

jobs:
  build-arm64-qemu:
    runs-on: ubuntu-latest

    env:
      PREFIX: ${{ github.workspace }}/qemu-arm64
      TARGET: aarch64-linux-android

    steps:
    # 1. Checkout repository
    - name: Checkout repo
      uses: actions/checkout@v3

    # 2. Install dependencies and cross toolchain
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y git wget unzip build-essential python3 pkg-config \
          libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev libaio-dev \
          ninja-build libtool gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

    # 3. Clone QEMU source
    - name: Clone QEMU
      run: |
        git clone --depth 1 https://github.com/qemu/qemu.git qemu-src

    # 4. Configure and build for ARM64 target
    - name: Configure and build
      run: |
        mkdir -p qemu-src/build
        cd qemu-src/build
        ../configure \
          --target-list=aarch64-softmmu \
          --cross-prefix=aarch64-linux-gnu- \
          --prefix=${PREFIX} \
          --enable-virtfs \
          --disable-sdl \
          --disable-cocoa \
          --disable-linux-user
        make -j$(nproc)
        make install

    # 5. Check binary
    - name: Check QEMU binary
      run: |
        file ${{ env.PREFIX }}/bin/qemu-system-aarch64
        ls -lh ${{ env.PREFIX }}/bin

    # 6. Upload artifact
    - name: Upload qemu-system-aarch64 ARM64 binary
      uses: actions/upload-artifact@v4
      with:
        name: qemu-system-arm64
        path: ${{ env.PREFIX }}/bin/qemu-system-aarch64
