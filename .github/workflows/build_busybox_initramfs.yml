name: Build ARM64 Initramfs (Prebuilt BusyBox)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      INITRAMFS_DIR: ${{ github.workspace }}/initramfs
      OUTPUT_DIR: ${{ github.workspace }}/output

    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y cpio gzip wget

    - name: Prepare directories
      run: |
        mkdir -p $INITRAMFS_DIR/bin
        mkdir -p $INITRAMFS_DIR/proc
        mkdir -p $INITRAMFS_DIR/sys
        mkdir -p $INITRAMFS_DIR/dev
        mkdir -p $INITRAMFS_DIR/newroot
        mkdir -p $OUTPUT_DIR

    - name: Download prebuilt ARM64 BusyBox
      run: |
        cd $INITRAMFS_DIR/bin
        wget -O busybox https://raw.githubusercontent.com/shutingrz/busybox-static-binaries-fat/main/busybox-aarch64-linux-gnu
        chmod +x busybox
        ln -sf busybox sh

    - name: Create init script
      run: |
        printf '%s\n' \
        '#!/bin/sh' \
        '' \
        'echo "Booting BusyBox initramfs..."' \
        'mount -t proc none /proc' \
        'mount -t sysfs none /sys' \
        'mount -t devtmpfs none /dev' \
        '' \
        'mkdir /newroot' \
        'echo "Mounting Alpine rootfs image..."' \
        'mount -t ext4 /dev/vda /newroot' \
        '' \
        'if [ $? -ne 0 ]; then' \
        '  echo "Mount failed!"' \
        '  exec sh' \
        'fi' \
        '' \
        'mount --move /proc /newroot/proc' \
        'mount --move /sys /newroot/sys' \
        'mount --move /dev /newroot/dev' \
        '' \
        'exec switch_root /newroot /sbin/init' \
        > $INITRAMFS_DIR/init

        chmod +x $INITRAMFS_DIR/init

    - name: Build initramfs
      run: |
        cd $INITRAMFS_DIR
        find . | cpio -o -H newc | gzip > $OUTPUT_DIR/initramfs.cpio.gz

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: initramfs-arm64
        path: ${{ env.OUTPUT_DIR }}/initramfs.cpio.gz
