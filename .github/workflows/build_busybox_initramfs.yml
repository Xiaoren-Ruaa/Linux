name: Build BusyBox ARM64 Initramfs

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      INITRAMFS_DIR: ${{ github.workspace }}/initramfs
      OUTPUT_DIR: ${{ github.workspace }}/output

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git bc cpio gzip wget flex bison \
                            gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu \
                            libc6-dev-arm64-cross

    - name: Prepare initramfs directories
      run: |
        mkdir -p $INITRAMFS_DIR/bin
        mkdir -p $OUTPUT_DIR

    - name: Download and extract BusyBox
      run: |
        cd $INITRAMFS_DIR/bin
        wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2
        tar xjf busybox-1.36.1.tar.bz2

    - name: Build BusyBox (ARM64 static, non-interactive)
      run: |
        cd $INITRAMFS_DIR/bin/busybox-1.36.1
        make distclean || true
        make defconfig
        # 设置静态编译
        sed -i 's/.*CONFIG_STATIC.*/CONFIG_STATIC=y/' .config
        # 非交互生成 include/autoconf.h
        yes "" | make oldconfig
        # ARM64 交叉编译，确保调用 aarch64-linux-gnu-ar
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc)
        # 拷贝 BusyBox 到 initramfs
        cp busybox ../busybox
        chmod +x ../busybox
        ln -sf busybox ../sh
        # 测试 BusyBox 文件类型
        file ../busybox

    - name: Create initramfs structure
      run: |
        mkdir -p $INITRAMFS_DIR/{proc,sys,dev,tmp,newroot}
        cp init $INITRAMFS_DIR/
        chmod +x $INITRAMFS_DIR/init
        chmod +x $INITRAMFS_DIR/bin/busybox
        chmod +x $INITRAMFS_DIR/bin/sh

    - name: Build initramfs.cpio.gz
      run: |
        cd $INITRAMFS_DIR
        find . | cpio -o -H newc | gzip > $OUTPUT_DIR/initramfs.cpio.gz

    - name: Verify initramfs contents
      run: |
        gzip -d -c $OUTPUT_DIR/initramfs.cpio.gz | cpio -t | grep -E "init|sh|busybox"

    - name: List output files
      run: ls -lh $OUTPUT_DIR
