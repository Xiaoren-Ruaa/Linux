name: Build BusyBox Initramfs

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      INITRAMFS_DIR: ${{ github.workspace }}/initramfs
      OUTPUT_DIR: ${{ github.workspace }}/output

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git bc cpio gzip wget flex bison

    - name: Prepare initramfs directories
      run: |
        mkdir -p $INITRAMFS_DIR/bin
        mkdir -p $OUTPUT_DIR

    - name: Download and extract BusyBox
      run: |
        cd $INITRAMFS_DIR/bin
        wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2
        tar xjf busybox-1.36.1.tar.bz2

    - name: Build BusyBox (ARM64 static, non-interactive)
      run: |
        cd $INITRAMFS_DIR/bin/busybox-1.36.1
        # 清理旧配置
        make distclean || true
        # 生成默认配置
        make defconfig
        # 设置静态编译
        sed -i 's/.*CONFIG_STATIC.*/CONFIG_STATIC=y/' .config
        # 非交互式生成 include/autoconf.h
        make olddefconfig
        # 编译 BusyBox
        make -j$(nproc)
        # 拷贝生成的 BusyBox
        cp busybox ../busybox
        chmod +x ../busybox
        ln -sf busybox ../sh

    - name: Create initramfs structure
      run: |
        mkdir -p $INITRAMFS_DIR/{proc,sys,dev,tmp,newroot}
        # 拷贝 init 脚本
        cp init $INITRAMFS_DIR/
        chmod +x $INITRAMFS_DIR/init
        # BusyBox 权限
        chmod +x $INITRAMFS_DIR/bin/busybox
        chmod +x $INITRAMFS_DIR/bin/sh

    - name: Test BusyBox presence in initramfs (dry run)
      run: |
        echo "Contents of initramfs directory before packaging:"
        find $INITRAMFS_DIR
        echo "Testing BusyBox binary:"
        file $INITRAMFS_DIR/bin/busybox
        ls -l $INITRAMFS_DIR/bin

    - name: Build initramfs.cpio.gz
      run: |
        cd $INITRAMFS_DIR
        find . | cpio -o -H newc | gzip > $OUTPUT_DIR/initramfs.cpio.gz

    - name: Verify initramfs contents
      run: |
        gzip -d -c $OUTPUT_DIR/initramfs.cpio.gz | cpio -t | grep -E "init|sh|busybox"

    - name: List output files
      run: ls -lh $OUTPUT_DIR
