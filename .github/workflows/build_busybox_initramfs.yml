name: Build ARM64 Initramfs (Prebuilt BusyBox)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      INITRAMFS_DIR: ${{ github.workspace }}/initramfs
      OUTPUT_DIR: ${{ github.workspace }}/output

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y cpio gzip wget

    - name: Prepare initramfs structure
      run: |
        mkdir -p $INITRAMFS_DIR/{bin,proc,sys,dev,tmp,newroot}
        mkdir -p $OUTPUT_DIR

    - name: Download prebuilt ARM64 BusyBox
      run: |
        cd $INITRAMFS_DIR/bin
        wget -O busybox https://raw.githubusercontent.com/shutingrz/busybox-static-binaries-fat/main/busybox-aarch64-linux-gnu
        chmod +x busybox
        ln -sf busybox sh
        file busybox

    - name: Add init script
      run: |
        cp $GITHUB_WORKSPACE/init $INITRAMFS_DIR/
        chmod +x $INITRAMFS_DIR/init

    - name: Build initramfs.cpio.gz
      run: |
        cd $INITRAMFS_DIR
        find . | cpio -o -H newc | gzip > $OUTPUT_DIR/initramfs.cpio.gz

    - name: Verify initramfs
      run: |
        gzip -d -c $OUTPUT_DIR/initramfs.cpio.gz | cpio -t | grep -E "init|busybox|sh"

    - name: Show output
      run: ls -lh $OUTPUT_DIR
